<html lang=en>
<head>
    <meta charset=utf-8>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Beth+Ellen&display=swap');
        @import url('https://fonts.googleapis.com/css?family=Dosis:200&display=swap');
    </style>

    <title> fixQuick Chatkit </title>

    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/chat.css')}}">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" media="screen">
</head>

<body>

    <div class="navbar">
        <a class="logo" href="{{ url_for('home', chtName=chtName) }}">Home</a>
        <a href="{{ url_for('profileStudent', chtName=chtName) }}">{{ chtName }}</a>
        <a href="#">Forums</a>
        <a href="{{ url_for('sessions', chtName=chtName) }}" >Chat</a>
        <a href="#">Saved</a>
        <a href="{{ url_for('login') }}"> Logout </a>
    </div>



    <div id="chatInfo">
        <h2> Hello {{ chtName }}</h2>
        <h4>Current Time: 11:54pm | Running Session Time: 12m 14s</h4>
        <h4 id="today-date"/> </h4>
        <h4 id="today-time"/> </h4>


    </div>

    <h2> {{ chtName }}'s rooms: </h2>
        <h3 id="room-to-pick"/> </h3>

        <h2> All Users: </h2>
        <h2 id="these-users"/> </h2>

        <h2> Current Room: </h2>
        <h3 id="room-name"/> </h3>

        <h2> room to join: </h2>
         <h3 id="room-to-join"/> </h3>

        <h2> Room Users: </h2>
        <h3 id="room-people"/> </h3>
        <br>
        <h2 id="room-users"/> </h2>





    <div id="chatWindow">




        <ul id="room-list"></ul>

        <form id="message-form">
            <input type='text' id='message-text'>
            <input type="submit">
        </form>
    </div>

    <script src="https://unpkg.com/@pusher/chatkit-client@1/dist/web/chatkit.js"></script>
    <script>

        var today = new Date();
        var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
        document.getElementById("today-date").innerHTML = date;

        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        document.getElementById("today-time").innerHTML = time;

      const tokenProvider = new Chatkit.TokenProvider({
        url: "https://us1.pusherplatform.io/services/chatkit_token_provider/v1/36e16942-3b74-4479-ba38-9c645865e6e5/token"
      });


        //uses name variable as chatkit id. must already exist.
      const chatManager = new Chatkit.ChatManager({
        instanceLocator: "v1:us1:36e16942-3b74-4479-ba38-9c645865e6e5",
        userId: "{{chtName}}",
        tokenProvider: tokenProvider
      });




      chatManager
        .connect()
        .then(currentUser => {

                //document.getElementById("room-topick").innerHTML = currentUser.rooms.name;

                   //gets users current rooms (already joined)
                   var roomArray = [];

                   roomArray = currentUser.rooms;
                   var result = ""
                   //var room_id = ""
                   for (i = 0; i < roomArray.length; i++)
                       //result = result + " <a href='" +"/private/" +roomArray[i].id.toString() + "'>"+ roomArray[i].id.toString() +"</a>";
                       //result = result + " " +roomArray[i].name.toString() + " <a href='"+"/private/" +roomArray[i].id.toString() +"' <br />" ;
                       result = result + " " +roomArray[i].name.toString() + " " +roomArray[i].id.toString() +" <br />" ;
                       document.getElementById("room-to-pick").innerHTML = result;

                   //var thisRoom = //roomArray[0].users.id.toString();

                   // var thisRoom = currentUser.rooms[0].users.id.toString();

            /*
                var nameArray = [];

                nameArray = currentUser.users;

                var resultName = ""

                for(i = 0; i< nameArray.length; i++)
                    //resultName = resultName + " " +nameArray[i].id.toString() + " <br/ > ";
                document.getElementById("all-users").innerHTML += nameArray[i].id.toString()+ "<br/>";
                //document.getElementById("all-users").innerHTML = resultName
                */
                //gets rooms joinable by user (not joined already)
                currentUser.getJoinableRooms()
                    .then(rooms => {

                        var joinableRoomArray = [];

                        joinableRoomArray = rooms;
                        var result = ""
                                //var room_id = ""
                        for (i = 0; i < joinableRoomArray.length; i++)
                        result = result + " " +joinableRoomArray[i].name.toString() + " " +joinableRoomArray[i].id.toString() +" <br />" ;
                        document.getElementById("room-to-join").innerHTML = result;

                    })
                    .catch(err => {
                        console.log(`Error getting joinable rooms: ${err}`)
                    })


                 //userArray = currentUser.rooms[0].users;

                   //   for (i = 0; i< userArray.length; i++)
                     //     document.getElementById("room-users").innerHTML += userArray[i].id.toString()+ ", " +userArray[i].id.toString()+"<br />";


                        //names
                        //document.getElementById("room-to-pick").innerHTML += (i+1) + ": " + roomArray[i].name.toString()+ " " +roomArray[i].id.toString()+"<br />";

            /*
            currentUser.subscribeToRoomMultipart({
                  roomId: '19440953',

                  hooks: {



                  }
              });



            currentUser.joinRoom({ roomId: '19440953' })
                .then(room => {

                    var nameArray = [];
                    nameArray = room.users;

                    //var resultName = ""
                    //for(i = 0; i< nameArray.length; i++)
                    //resultName = resultName + " " +nameArray[i].id.toString() + " <br/ > ";
                    //document.getElementById("these-users").innerHTML += nameArray[i].id.toString()+ "<br/>";
                    document.getElementById("these-users").innerHTML = nameArray.length.toString();
                    //document.getElementById("all-users").innerHTML += resultName;


                        console.log(`Joined room with ID: ${room.name}`)
                        })
                        .catch(err => {
                        console.log(`Error joining room ${'19442100'}: ${err}`)
                        })
            /*

            /*
              currentUser.subscribeToRoomMultipart({
                  roomId: '19442100',

                  hooks: {
                     onUser: message => {

                          var nameArray = [];

                        nameArray = message.room.users;

                var resultName = ""

                for(i = 0; i< nameArray.length; i++)
                    //resultName = resultName + " " +nameArray[i].id.toString() + " <br/ > ";
                document.getElementById("all-users").innerHTML += nameArray[i].id.toString()+ "<br/>";
                  }
                  }
              }); */

              currentUser.subscribeToRoomMultipart({

                roomId: "{{roomID}}",
                //roomId: currentUser.rooms[0].id,
                //userArray: currentUser.rooms[0].users,
                hooks: {


                  onMessage: message => {

                      //var thisRoom = currentUser.rooms[0].users.id.toString();

                      //userArray = message.room.users;

                      //for (i = 0; i< userArray.length; i++)
                        //  document.getElementById("room-users").innerHTML += userArray[i].id.toString()+ ", " +userArray[i].id.toString()+"<br />";

                      //document.getElementById("room-users").innerHTML = message.room.users.id;

                      // gets current room name
                   document.getElementById("room-name").innerHTML = message.room.name;

                   /*
                   //gets current rooms users returns their ids as strings
                   var usersArray = [];
                   usersArray = message.room.users;
                   for (i = 0; i< usersArray.length; i++)
                   document.getElementById("room-people").innerHTML += usersArray[i].id.toString()+ "<br/>";
                   //document.getElementById("room-users").innerHTML = message.room.users.id;
                      //document.createTextNode(` ${message.room.name}: ${message.senderId}: ${
                   */
                    //returns chat with the senderId
                    const ul = document.getElementById("room-list");
                    const li = document.createElement("li");
                    li.appendChild(
                      document.createTextNode(` ${message.senderId}: ${

                        message.parts[0].payload.content
                      }`
                      )
                    );
                    ul.appendChild(li);

                  }
                }
              });

              //form that sends message
              const form = document.getElementById("message-form");
              form.addEventListener("submit", e => {
                e.preventDefault();
                const input = document.getElementById("message-text");
                currentUser.sendSimpleMessage({
                  text: input.value,
                  roomId: currentUser.rooms[0].id
                });
                input.value = "";
              });
        })
        .catch(error => {
          console.error("error:", error);
        });


    </script>
  </body>
</html>